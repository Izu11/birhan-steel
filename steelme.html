<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIRHAN STEEL | Live System</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* THEME */
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f1f5f9; --text: #1e293b; --danger: #ef4444; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; margin:0; }
        
        /* Sidebar & Main */
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #1e293b; text-align: center; }
        .logo-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); background: white; object-fit: cover; }
        .nav-btn { background: none; border: none; padding: 15px 20px; text-align: left; width: 100%; color: #ccc; cursor: pointer; font-size: 1rem; }
        .nav-btn.active { background: rgba(37,99,235,0.2); color: white; border-left: 4px solid var(--accent); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Components */
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .form-control { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-primary { background: var(--accent); } .btn-danger { background: var(--danger); }
        .section { display: none; } .section.active { display: block; }
        table { width: 100%; border-collapse: collapse; background: white; } th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }

        /* DEBUG LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #error-log { margin-top: 20px; color: red; background: #fee2e2; padding: 10px; border-radius: 5px; max-width: 80%; font-family: monospace; display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <h2 style="color:#2563eb;">Connecting to Live Database...</h2>
        <div id="spinner" style="width:40px; height:40px; border:4px solid #ccc; border-top:4px solid #2563eb; border-radius:50%; animation: spin 1s linear infinite;"></div>
        <p id="status-text">Authenticating...</p>
        
        <div id="error-log"></div>
        
        <button id="skip-btn" onclick="forceSkip()" style="display:none; margin-top:20px; padding:10px 20px; background:#64748b; color:white; border:none; border-radius:5px; cursor:pointer;">
            ‚ö†Ô∏è Force Start (Offline Mode)
        </button>
        
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="logo.jpeg" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/80?text=Logo'">
            <h3>BIRHAN STEEL</h3>
        </div>
        <button class="nav-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="nav-btn" onclick="switchTab('inventory')">üì¶ Inventory</button>
        <button class="nav-btn" onclick="switchTab('sales')">üí∞ Sales</button>
        <button class="nav-btn" onclick="switchTab('purchases')">üì• Stock Entry</button>
        <button class="nav-btn" onclick="switchTab('reports')">üìã Reports</button>
    </aside>

    <main class="main-content">
        <div id="connection-status" style="background:#fee2e2; color:#991b1b; padding:10px; margin-bottom:20px; border-radius:5px; display:none;">
            <b>Offline / Error:</b> Changes will not save to cloud. Check console for details.
        </div>

        <section id="dashboard" class="section active">
            <h1>Overview</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="card"><h3>Cambridge Stock</h3><div class="value" id="dash-val-cam">...</div></div>
                <div class="card"><h3>Store Stock</h3><div class="value" id="dash-val-store">...</div></div>
                <div class="card"><h3>Low Stock Items</h3><div class="value" id="dash-low">...</div></div>
            </div>
        </section>

        <section id="inventory" class="section">
            <h1>Inventory</h1>
            <div class="card" style="margin-bottom:20px;">
                <h3>Add Item</h3>
                <form id="add-form" onsubmit="handleAddItem(event)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input id="i-type" class="form-control" placeholder="Type (e.g. Pipe)" required>
                        <input id="i-dim" class="form-control" placeholder="Dimension (e.g. 40x40)" required>
                        <input id="i-price" type="number" class="form-control" placeholder="Price" required>
                        <input id="i-qty" type="number" class="form-control" placeholder="Qty" required>
                        <select id="i-loc" class="form-control"><option>Store</option><option>Cambridge</option></select>
                    </div>
                    <button class="btn btn-primary">Save Item</button>
                </form>
            </div>
            <div id="inv-list"></div>
        </section>

        <section id="sales" class="section"><h1>Sales</h1><p>Go to Inventory to check items first.</p></section>
        <section id="purchases" class="section"><h1>Stock Entry</h1><p>Use Inventory tab.</p></section>
        <section id="reports" class="section"><h1>Reports</h1><p>Data loading...</p></section>
    </main>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyAdpvuUAGnj2ixxAdjbhntd775V5FEVH9M",
          authDomain: "birhan-steel.firebaseapp.com",
          projectId: "birhan-steel",
          storageBucket: "birhan-steel.firebasestorage.app",
          messagingSenderId: "446485440628",
          appId: "1:446485440628:web:f93bc5791d45ae64944921"
        };

        // --- 2. INITIALIZATION WITH ERROR HANDLING ---
        let db;
        let appData = { inventory: [], sales: [] };
        let isConnected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            document.getElementById('status-text').innerText = "Database Connected. Waiting for data...";
            
            // Start Listener
            db.collection('birhan_data').doc('main').onSnapshot((doc) => {
                isConnected = true;
                if (doc.exists) {
                    appData = doc.data();
                    console.log("Data loaded:", appData);
                    refreshUI();
                    closeLoader();
                } else {
                    document.getElementById('status-text').innerText = "Creating new database...";
                    db.collection('birhan_data').doc('main').set(appData)
                        .then(() => { refreshUI(); closeLoader(); })
                        .catch(reportError);
                }
            }, (error) => {
                reportError(error);
            });

        } catch (e) {
            reportError(e);
        }

        // --- 3. HELPER FUNCTIONS ---
        function reportError(err) {
            console.error(err);
            document.getElementById('spinner').style.display = 'none';
            const log = document.getElementById('error-log');
            log.style.display = 'block';
            log.innerHTML = "<b>ERROR:</b> " + err.message + "<br><br>Check Firebase 'Rules' tab is set to TRUE.";
            document.getElementById('skip-btn').style.display = 'block';
        }

        function closeLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function forceSkip() {
            closeLoader();
            document.getElementById('connection-status').style.display = 'block';
            // Load dummy data so user can see UI
            appData.inventory = [{type:'Test', dimensions:'0x0', location:'Store', price:0, qty:0}];
            refreshUI();
        }

        // UI Logic
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function refreshUI() {
            const inv = appData.inventory || [];
            // Dashboard
            const camVal = inv.filter(i => i.location === 'Cambridge').reduce((a,b) => a + (b.price*b.qty), 0);
            const storeVal = inv.filter(i => i.location === 'Store').reduce((a,b) => a + (b.price*b.qty), 0);
            document.getElementById('dash-val-cam').innerText = camVal.toLocaleString() + ' ETB';
            document.getElementById('dash-val-store').innerText = storeVal.toLocaleString() + ' ETB';
            document.getElementById('dash-low').innerText = inv.filter(i=>i.qty<20).length;

            // Inventory List
            let html = `<table><thead><tr><th>Type</th><th>Dim</th><th>Loc</th><th>Qty</th></tr></thead><tbody>`;
            inv.forEach(i => {
                html += `<tr><td>${i.type}</td><td>${i.dimensions}</td><td>${i.location}</td><td>${i.qty}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('inv-list').innerHTML = html;
        }

        function handleAddItem(e) {
            e.preventDefault();
            const newItem = {
                id: Date.now().toString(),
                type: document.getElementById('i-type').value,
                dimensions: document.getElementById('i-dim').value,
                price: parseFloat(document.getElementById('i-price').value),
                qty: parseInt(document.getElementById('i-qty').value),
                location: document.getElementById('i-loc').value
            };
            
            appData.inventory.push(newItem);
            
            if(isConnected) {
                db.collection('birhan_data').doc('main').update({ inventory: appData.inventory })
                    .then(() => { alert("Saved!"); e.target.reset(); })
                    .catch(err => alert("Save failed: " + err.message));
            } else {
                alert("Offline mode: Item shown but not saved to cloud.");
                refreshUI();
            }
        }
        
        // Timeout check
        setTimeout(() => {
            if(document.getElementById('loader').style.display !== 'none') {
                document.getElementById('status-text').innerText = "taking a long time...";
                document.getElementById('skip-btn').style.display = 'block';
            }
        }, 5000);
    </script>
</body>
</html>